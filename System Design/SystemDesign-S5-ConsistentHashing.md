<!-- language: rtl -->
<div dir="rtl"align="right" >

![](./Pictures/consistent%20hashing%202.png)
![](./Pictures/consistent%20hashing%201.png)
## 5. ุทุฑุงุญ ุงูฺฏูุฑุชู Consistent Hashing (ูุดโุณุงุฒ ุณุงุฒฺฏุงุฑ)

### **Consistent Hashing ฺุณุชุ**  
**Consistent Hashing** ฺฉ ุชฺฉูฺฉ ุชูุฒุน ุฏุงุฏู (Data Distribution) ุงุณุช ฺฉู ุจุฑุง **ุชูุณู ุจุงุฑ (Load Balancing)** ู **ฺฉุงูุด ุฌุงุจุฌุง ุฏุงุฏู (Data Rebalancing)** ุฏุฑ ุณุณุชูโูุง ุชูุฒุนโุดุฏู (ูุซู ูพุงฺฏุงูโุฏุงุฏูโูุงุ ฺฉุดโูุง ู CDNูุง) ุงุณุชูุงุฏู ูโุดูุฏ.  

---

### **ฺุฑุง ุงุฒ Consistent Hashing ุงุณุชูุงุฏู ูโุดูุฏุ**  
1. **ฺฉุงูุด ุฌุงุจุฌุง ุฏุงุฏู ููฺฏุงู ุงุถุงูู/ุญุฐู ุณุฑูุฑูุง**  
   - ุฏุฑ ุณุณุชูโูุง ูุนูููุ ุงฺฏุฑ ฺฉ ุณุฑูุฑ ุงุถุงูู ุดูุฏุ ุชูุฑุจุงู ุชูุงู ฺฉูุฏูุง ุจุงุฏ ุฏูุจุงุฑู ูุญุงุณุจู ุดููุฏ (`hash(key) % N` ุฌุฏุฏ).  
   - ุฏุฑ Consistent Hashingุ ููุท ุฏุงุฏูโูุง ูุฒุฏฺฉ ุจู ููุทู ุชุบุฑ ุฌุงุจุฌุง ูโุดููุฏ.  

2. **ุชูุฒุน ฺฉููุงุฎุชโุชุฑ ุฏุงุฏู (Load Balancing ุจูุชุฑ)**  
   - ุจุง ุงุณุชูุงุฏู ุงุฒ **Virtual Nodes**ุ ูโุชูุงู ุชูุฒุน ุฏุงุฏู ุฑุง ุนุงุฏูุงููโุชุฑ ฺฉุฑุฏ.  

3. **ููุงููุช ุฏุฑ ุจุฑุงุจุฑ ุชุบุฑุงุช ููุงุณ (Scalability)**  
   - ููุงุณุจ ุจุฑุง ุณุณุชูโูุง ฺฉู ูุฏุงู ุฏุฑ ุญุงู ุฑุดุฏ ุง ฺฉูฺฺฉโุดุฏู ูุณุชูุฏ (ูุซู **DynamoDBุ Cassandraุ Redis Cluster**).  

---

### **ฺุฑุง Consistent Hashing ููู ุงุณุชุ**  
- **ุจูุจูุฏ Performance**: ฺูู ุฌุงุจุฌุง ุฏุงุฏู ฺฉู ูโุดูุฏุ ุฒูุงู ุชุฃุฎุฑ (Latency) ฺฉุงูุด ูโุงุจุฏ.  
- **ฺฉุงูุด ูุฒูู ุดุจฺฉู**: ููุช ุฏุงุฏู ฺฉูุชุฑ ุฌุงุจุฌุง ุดูุฏุ ูพููุง ุจุงูุฏ ฺฉูุชุฑ ูุตุฑู ูโุดูุฏ.  
- **ุชุญูู ุฎุทุง (Fault Tolerance)**: ุงฺฏุฑ ฺฉ ุณุฑูุฑ ุงุฒ ฺฉุงุฑ ุจูุชุฏุ ููุท ุจุฎุด ุงุฒ ุฏุงุฏูโูุง ุชุญุช ุชุฃุซุฑ ูุฑุงุฑ ูโฺฏุฑูุฏ.  

---

### **ฺฉุงุฑุจุฑุฏูุง Consistent Hashing**  
1. **ุณุณุชูโูุง ฺฉุด ุชูุฒุนโุดุฏู (Distributed Caching)**  
   - ูุซู **Memcachedุ Redis Cluster**  
2. **ูพุงฺฏุงูโุฏุงุฏูโูุง NoSQL**  
   - ูุซู **Cassandraุ DynamoDB**  
3. **ุดุจฺฉูโูุง ุชูุฒุน ูุญุชูุง (CDN)**  
   - ุจุฑุง ูุณุฑุงุจ ุฏุฑุฎูุงุณุชโูุง ุจู ูุฒุฏฺฉโุชุฑู ุณุฑูุฑ  
4. **ูฺฉุฑูุณุฑูุณโูุง ู Load Balancerูุง**  
   - ูุซู **Nginxุ Envoy**  


ุจุฑุง ุฏุณุชุงุจ ุจู **ููุงุณโูพุฐุฑ ุงูู (Horizontal Scaling)**ุ ุถุฑูุฑ ุงุณุช ฺฉู ุฏุฑุฎูุงุณุชโูุง ุง ุฏุงุฏูโูุง ุจูโุตูุฑุช **ููุซุฑ ู ฺฉููุงุฎุช** ุจู ุณุฑูุฑูุง ุชูุฒุน ุดููุฏ. ฺฉ ุงุฒ ุฑูุดโูุง ุฑุงุฌ ุจุฑุง ุชุญูู ุงู ูุฏูุ ุงุณุชูุงุฏู ุงุฒ ุชฺฉูฺฉ ุจู ูุงู **Consistent Hashing (ูุดโุณุงุฒ ุณุงุฒฺฏุงุฑ)** ุงุณุช. ุงูุง ูพุด ุงุฒ ุจุฑุฑุณ ุงู ุฑูุดุ ุงุจุชุฏุง ุจุงุฏ ุจูโุตูุฑุช ุนูู ูุณุฆููโุง ุจู ูุงู **ูุดฺฉู Rehashing (ุจุงุฒูุดโุณุงุฒ)** ุฑุง ุฏุฑฺฉ ฺฉูู.

---

### *ต.ฑ ูุดฺฉู ุจุงุฒูุดโุณุงุฒ (Rehashing Problem)*

ูุฑุถ ฺฉูุฏ ูุง **n ุณุฑูุฑ ฺฉุด (Cache Server)** ุฏุฑ ุงุฎุชุงุฑ ุฏุงุฑู. ฺฉ ุฑูุด ูุนููู ุจุฑุง ุชูุฒุน ุจุงุฑ ุจู ุงู ุณุฑูุฑูุงุ ุงุณุชูุงุฏู ุงุฒ ูุฑููู ุฒุฑ ุจุฑุง ูฺฏุงุดุช ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ุงุณุช:


```python
server_index = hash(key) % N
```

ฺฉู ุฏุฑ ุขู:

* `key`: ฺฉูุฏ ุงุณุช ฺฉู ูโุฎูุงูู ุฏุฑ ฺฉุด ุฐุฎุฑู ุง ุจุงุฒุงุจ ฺฉููุ
* `N`: ุชุนุฏุงุฏ ุณุฑูุฑูุง ููุฌูุฏ ุฏุฑ ุณุณุชู ุงุณุช.

ุจุฑุง ุฏุฑฺฉ ุจูุชุฑุ ุงุฒ ฺฉ ูุซุงู ุงุณุชูุงุฏู ูโฺฉูู.

**ุฌุฏูู 5-1: ุชูุฒุน ฺฉูุฏูุง ุจุฑ ุงุณุงุณ ููุฏุงุฑ ูุด ู ูฺฏุงุดุช ุจู ุณุฑูุฑ**

| ฺฉูุฏ (Key) | ููุฏุงุฑ Hash | Hash % 4 | ุณุฑูุฑ ุงูุชุฎุงุจ |
| ---------- | ---------- | -------- | ------------ |
| key0       | 120        | 0        | server0      |
| key1       | 123        | 3        | server3      |
| key2       | 125        | 1        | server1      |
| key3       | 140        | 0        | server0      |
| key4       | 142        | 2        | server2      |
| key5       | 146        | 2        | server2      |
| key6       | 150        | 2        | server2      |
| key7       | 153        | 1        | server1      |

ุฏุฑ ุงู ุฑูุดุ ุจุฑุง ุงูุชู ุณุฑูุฑ ฺฉู ฺฉ ฺฉูุฏ ุฏุฑ ุขู ุฐุฎุฑู ุดุฏูุ ฺฉุงู ุงุณุช ุนููุงุช `hash(key) % 4` ุฑุง ุงูุฌุงู ุฏูู.
ุจุฑุง ููููู: `hash(key0) % 4 = 0`ุ ุนู ฺฉูุฏ `key0` ุจุงุฏ ุฏุฑ `server0` ุฐุฎุฑู ุดูุฏ.

---

![](./Pictures/5-1%20fig.png)
(ุชุตูุฑ ุชูุฒุน ฺฉูุฏูุง ุฑู ุณุฑูุฑูุง ุฑุง ุจุฑ ุงุณุงุณ ุฌุฏูู 5-1 ููุงุด ูโุฏูุฏ)

---

### \[+] ูุดฺฉู ุงุตู ุงู ุฑูุด ฺุณุชุ

ุงฺฏุฑ ุชุนุฏุงุฏ ุณุฑูุฑูุง ุชุบุฑ ฺฉูุฏ (ูุซูุงู ฺฉ ุณุฑูุฑ ุงุถุงูู ุง ฺฉู ุดูุฏ)ุ ููุฏุงุฑ `N` ุชุบุฑ ูโฺฉูุฏ ู ุฏุฑ ูุชุฌู `hash(key) % N` ูุชุงุฌ ูุชูุงูุช ุชููุฏ ูโฺฉูุฏ. ุงู ุงูุฑ ุจุงุนุซ ูโุดูุฏ ุงฺฉุซุฑ ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ูุชูุงูุช ูุณุจุช ุจู ูุจู ูฺฏุงุดุช ุดููุฏ ู ุฏุฑ ูุชุฌู:

* ฺฉุด ูุนู ุจโุงุซุฑ (Invalidated) ุดูุฏ.
* ูุงุฒ ุจู ุงูุชูุงู ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ุจุงุดุฏ.
* ุชุงุฎุฑ ุฒุงุฏ ู ุจุงุฑ ุงุถุงู ุฏุฑ ุณุณุชู ุงุฌุงุฏ ุดูุฏ.

---

### \[+] ูุทุงูุนู ููุฑุฏ: ุทุฑุงุญ ุณุณุชู ฺฉุด ุชูุฒุนโุดุฏู ุฏุฑ Memcached (ูุณุจูฺฉ)

> ุฏุฑ ุทุฑุงุญ ุณุณุชู Memcached ุชูุณุท ูุณุจูฺฉุ ุจุฑุง ุญู ูุดฺฉู Rehashing ูุงุด ุงุฒ ุงุถุงููโฺฉุฑุฏู ุง ุญุฐู ุณุฑูุฑุ ุงูฺฏูุฑุชู Consistent Hashing ุจู ฺฉุงุฑ ฺฏุฑูุชู ุดุฏ. ุงู ุฑูุด ุจุงุนุซ ุดุฏ ุชุง ุชููุง ุจุฎุด ฺฉูฺฺฉ ุงุฒ ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ุฌุฏุฏ ููุชูู ุดููุฏุ ูู ุชูุงู ุฏุงุฏูโูุง.
>
> ููุจุน: Engineering Facebookโs Memcached infrastructure โ [Facebook Engineering Blog, 2011](https://engineering.fb.com/2011/04/28/core-data/scaling-memcache-at-facebook/)


### ต.ฒ ูุดฺฉู ูฺฏุงุดุช ูุงูพุงุฏุงุฑ ุฏุฑ ุฒูุงู ุชุบุฑ ุงูุฏุงุฒู ุณุฑูุฑูุง

ุฑูฺฉุฑุฏ `hash(key) % N` ุฒูุงู ุจู ุฎูุจ ฺฉุงุฑ ูโฺฉูุฏ ฺฉู:
- **ุชุนุฏุงุฏ ุณุฑูุฑูุง ุซุงุจุช ุจุงุดุฏ**ุ
- ู **ุชูุฒุน ุฏุงุฏูโูุง ุจู ุณุฑูุฑูุง ฺฉููุงุฎุช ุจุงุดุฏ**.

ุงูุง ุฏุฑ ุฏูุง ูุงูุนุ ฺูู ุซุจุงุช ูุงุฏุฑ ุงุณุช. ูุนูููุงู ุณุฑูุฑูุง ุจู ุฏูุงู ูุฎุชูู ุงุถุงูู ุง ุญุฐู ูโุดููุฏ:
- **ุงูุฒุงุด ุชุฑุงูฺฉ** (ูุงุฒ ุจู ููุงุณโูพุฐุฑ ุงูู)ุ
- **ุฎุฑุงุจ ุณุฑูุฑ ุง ุฎุงุฑุฌโุดุฏู ุงุฒ ุณุฑูุณ**ุ
- **ุจุฑูุฒุฑุณุงู ุณุฎุชโุงูุฒุงุฑ ุง ูุฑูโุงูุฒุงุฑ**.

---

### *ูุดฺฉู ุฏุฑ ุฒูุงู ุญุฐู ฺฉ ุณุฑูุฑ*

ูุฑุถ ฺฉูุฏ `server1` ุงุฒ ุฏุณุชุฑุณ ุฎุงุฑุฌ ุดูุฏ. ุฏุฑ ุงู ุญุงูุชุ ุชุนุฏุงุฏ ุณุฑูุฑูุง ุงุฒ `4` ุจู `3` ฺฉุงูุด ูโุงุจุฏ. ุฏุฑ ูุชุฌู:

```python
server_index = hash(key) % 3
```

ุงฺฏุฑฺู ุชุงุจุน ูุด ุจุฑุง ูุฑ ฺฉูุฏ ููฺูุงู ููุงู ููุฏุงุฑ ุฑุง ุชููุฏ ูโฺฉูุฏุ ุงูุง ุชุบุฑ ุฏุฑ ุชุนุฏุงุฏ ุณุฑูุฑูุง (ุงุฒ 4 ุจู 3)ุ ุจุงุนุซ ูโุดูุฏ ุฎุฑูุฌ ุชุงุจุน ูุฏููุงุฑ (`% N`) ุชุบุฑ ฺฉูุฏ ู **ุงุบูุจ ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ูุชูุงูุช ูุณุจุช ุจู ูุจู ูฺฏุงุดุช ุดููุฏ**.

---

**ุฌุฏูู 5-2: ูฺฏุงุดุช ุฌุฏุฏ ฺฉูุฏูุง ูพุณ ุงุฒ ุญุฐู server1**

| ฺฉูุฏ (Key) | ููุฏุงุฑ Hash | Hash % 4 (ูุจู) | Hash % 3 (ุฌุฏุฏ) | ุณุฑูุฑ ุฌุฏุฏ |
| ---------- | ---------- | --------------- | --------------- | --------- |
| key0       | 120        | 0               | 0               | server0   |
| key1       | 123        | 3               | 0               | server0   |
| key2       | 125        | 1               | 2               | server2   |
| key3       | 140        | 0               | 2               | server2   |
| key4       | 142        | 2               | 1               | server1   |
| key5       | 146        | 2               | 2               | server2   |
| key6       | 150        | 2               | 0               | server0   |
| key7       | 153        | 1               | 0               | server0   |

---

![](./Pictures/fig%205-2.png)
(ูุดุงูโุฏููุฏู ุชูุฒุน ุฌุฏุฏ ฺฉูุฏูุง ูพุณ ุงุฒ ุญุฐู ฺฉ ุงุฒ ุณุฑูุฑูุง)

---

### *ุชุญูู ูุดฺฉู:*

ููุงูโุทูุฑ ฺฉู ุฏุฑ ุชุตูุฑ ูุดุงูุฏู ูโุดูุฏุ **ุจุดุชุฑ ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ุฌุฏุฏ ูฺฏุงุดุช ุดุฏูโุงูุฏุ ูู ููุท ฺฉูุฏูุง ฺฉู ุฑู ุณุฑูุฑ ุขููุงู `server1` ูุฑุงุฑ ุฏุงุดุชูุฏ.**

ูุชุฌู:

* ุจุดุชุฑ ุฏุฑุฎูุงุณุชโูุง ฺฉุด ุงุฒ ุณูุช ฺฉูุงูุชโูุง ุจู ุณุฑูุฑ ุงุดุชุจุงู ุงุฑุณุงู ูโุดูุฏ.
* ููุฌุฑ ุจู **ุญุฌู ุจุงูุง cache miss** ูโุดูุฏ.
* ูุดุงุฑ ูุงฺฏูุงู ุจู ุฏุชุงุจุณ ุงุตู ูุงุฑุฏ ูโุดูุฏ (ุจูโุฏูู cache miss).
* ุนููฺฉุฑุฏ ฺฉู ุณุณุชู ุจู ุดุฏุช ุงูุช ูโฺฉูุฏ.

---

### \[+] ุฑุงูโุญู: ุงุณุชูุงุฏู ุงุฒ Consistent Hashing

ุงูฺฏูุฑุชู **Consistent Hashing (ูุดโุณุงุฒ ุณุงุฒฺฏุงุฑ)** ุฑุงูโุญู ูุคุซุฑ ุจุฑุง ฺฉุงูุด ุงู ูุดฺฉู ุงุณุช. ุงู ุฑูุด ุชุถูู ูโฺฉูุฏ ฺฉู:

* ุจุง **ุญุฐู ุง ุงุถุงูู ุดุฏู ุณุฑูุฑ ุฌุฏุฏ**ุ ููุท ุจุฎุด ฺฉูฺฺฉ ุงุฒ ฺฉูุฏูุง ูุงุฒ ุจู ุจุงุฒุชุฎุตุต ุฏุงุฑูุฏ.
* **ุงฺฉุซุฑุช ฺฉูุฏูุง** ุฑู ุณุฑูุฑูุง ูุจู ุจุงู ูโูุงููุฏ.

## ต. ูุดูฺฏ ูพุงุฏุงุฑ (Consistent Hashing)

---

### **ต.ฑ ุชุนุฑู ูุดูฺฏ ูพุงุฏุงุฑ**

> ุจุฑฺฏุฑูุชู ุงุฒ ูฺฉโูพุฏุง:
> ยซูุดูฺฏ ูพุงุฏุงุฑ ููุน ุฎุงุต ุงุฒ ูุดูฺฏ ุงุณุช ฺฉู ุฏุฑ ุขูุ ููฺฏุงู ุชุบุฑ ุงูุฏุงุฒู ุฌุฏูู ูุดุ ุชููุง ุจูโุทูุฑ ูุงูฺฏู $\frac{k}{n}$ ฺฉูุฏ ูุงุฒ ุจู ุจุงุฒูฺฏุงุดุช ุฏุงุฑุฏุ ฺฉู ุฏุฑ ุขู $k$ ุชุนุฏุงุฏ ฺฉูุฏูุง ู $n$ ุชุนุฏุงุฏ ุงุณูุงุชโูุงุณุช. ุฏุฑ ุญุงู ฺฉู ุฏุฑ ุจุดุชุฑ ุฌุฏููโูุง ูุด ุณูุชุ ุชุบุฑ ุชุนุฏุงุฏ ุงุณูุงุชโูุง ุจุงุนุซ ูโุดูุฏ ุชูุฑุจุงู ุชูุงู ฺฉูุฏูุง ูุงุฒ ุจู ุจุงุฒูฺฏุงุดุช ุฏุงุดุชู ุจุงุดูุฏ.ยป[^1]

---

### **ต.ฒ ูุถุง ูุด ู ุญููู ูุด (Hash Ring)**

ุงฺฉููู ฺฉู ุชุนุฑู ูุดูฺฏ ูพุงุฏุงุฑ ุฑุง ุฏุฑฺฉ ฺฉุฑุฏูุ ุจุงุฏ ูุญูู ุนููฺฉุฑุฏ ุขู ุฑุง ุจุฑุฑุณ ฺฉูู.

ูุฑุถ ฺฉูู ุชุงุจุน ูุด ูุง `f`ุ ุงุฒ ููุน `SHA-1` ุจุงุดุฏ. ูุถุง ุฎุฑูุฌ ุงู ุชุงุจุน ุดุงูู ูุฌููุนูโุง ุงุฒ ููุงุฏุฑ ุนุฏุฏ ูุงููุฏ:
`x0, x1, x2, ..., xn` ุงุณุช.
ุฏุฑ ุฑูุฒูฺฏุงุฑุ ูุถุง ูุด SHA-1 ุจุฑุงุจุฑ ุงุณุช ุจุง ุจุงุฒูโุง ุจู `ฐ` ุชุง `2^160 - 1`. ุจู ุนุจุงุฑุช ุฏฺฏุฑ:

* `x0 = 0`
* `xn = 2^160 - 1`
* ู ุณุงุฑ ููุงุฏุฑ ูุด ุฏุฑ ุงู ุจุงุฒู ูุฑุงุฑ ูโฺฏุฑูุฏ.

![](./Pictures/5-3.png)

ุงฺฉููู ุงฺฏุฑ ุฏู ุงูุชูุง ุงู ุจุงุฒู ุฑุง ุจู ฺฉุฏฺฏุฑ ูุชุตู ฺฉููุ ูุถุง ุฎุท ุจู ฺฉ *ุญููู ูุด (Hash Ring)* ุชุจุฏู ูโุดูุฏ.

![](./Pictures/5-4.png)

---

### **ต.ณ ูฺฏุงุดุช ุณุฑูุฑูุง ุจุฑ ุฑู ุญููู ูุด**

ุจุง ุงุณุชูุงุฏู ุงุฒ ููุงู ุชุงุจุน ูุด `f`ุ ูุฑ ุณุฑูุฑ ุฑุง ุจุฑ ุงุณุงุณ `IP` ุง `hostname` ุขูุ ุฑู ุญููู ูุด ูฺฏุงุดุช ูโฺฉูู.

ุจู ุนููุงู ูุซุงูุ ูุฑุถ ฺฉูุฏ ด ุณุฑูุฑ ุฏุฑ ุณุณุชู ุฏุงุฑู. ูพุณ ุงุฒ ูุด ฺฉุฑุฏู IP ุง ูุงู ูุฑ ุณุฑูุฑุ ูููุนุช ุขูโูุง ุฑู ุญููู ูุดุฎุต ูโุดูุฏ.

![](./Pictures/5-5.png)
---

### \[+] *ูุทุงูุนู ููุฑุฏ: ุงุณุชูุงุฏู ุงุฒ Consistent Hashing ุฏุฑ Amazon DynamoDB*

> ฺฉ ุงุฒ ฺฉุงุฑุจุฑุฏูุง ูุงูุน ูุดูฺฏ ูพุงุฏุงุฑุ ุฏุฑ ุทุฑุงุญ **Amazon DynamoDB** ูุดุงูุฏู ูโุดูุฏ.
> ุฏุฑ Dynamoุ ุจุฑุง ุชูุฒุน ฺฉูุฏูุง ุฏุฑ ูุงู ููุฏูุง (Nodes)ุ ุงุฒ ุญููู ูุด ุงุณุชูุงุฏู ูโุดูุฏ.
> ูุฑ ููุฏ ุจู ฺูุฏ ูููุนุช ุฑู ุญููู ูฺฏุงุดุช ูโุดูุฏ (Virtual Nodes)ุ ุชุง ุชูุฒุน ฺฉููุงุฎุชโุชุฑ ุญุงุตู ุดูุฏ.
>
> ููุจุน: [Amazon Dynamo Paper, SOSP 2007](https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf)


### \[+] ูุฒุงุง ุงุณุชูุงุฏู ุงุฒ Hash Ring ุฏุฑ ูุนูุงุฑ ูุฏุฑู:

| ูฺฺฏ                    | Consistent Hashing   | Hash Modulo (ุณูุช) |
| ------------------------ | -------------------- | ------------------ |
| ุชูุฒุน ฺฉููุงุฎุช ฺฉูุฏูุง     | โ ุจูู                | โ ูู               |
| ุชุงุซุฑ ฺฉู ุงุฒ ุชุบุฑ ุณุฑูุฑูุง | โ ุชููุง ุจุงุฒูฺฏุงุดุช ุฌุฒุฆ | โ ุจุงุฒูฺฏุงุดุช ฺฉุงูู    |
| ููุงุณโูพุฐุฑ ุงูู         | โ ุนุงู               | โ ูุดฺฉูโุณุงุฒ         |

---

[^1]: Wikipedia - [Consistent Hashing](https://en.wikipedia.org/wiki/Consistent_hashing)


## **ต.ณ ฺฉูุฏูุง ูุด (Hash Keys)**

ูฺฉุชูโุง ฺฉู ุดุงุงู ุฐฺฉุฑ ุงุณุช ุงู ุงุณุช ฺฉู ุชุงุจุน ูุด ููุฑุฏ ุงุณุชูุงุฏู ุฏุฑ ุงู ุจุฎุด ุจุง ุชุงุจุน ูุด ุฏุฑ ุจุฎุด ยซูุดฺฉู ุจุงุฒูโุจูุฏ ูุฌุฏุฏ (rehashing problem)ยป ูุชูุงูุช ุงุณุช. ููฺูู ุฏุฑ ุงูุฌุง ูฺ ุนููุงุช ูุฏููุงุฑ (modular operation) ูุฌูุฏ ูุฏุงุฑุฏ.

![](./Pictures/5-6.png)

ููุงูโุทูุฑ ฺฉู ุฏุฑ **ุชุตูุฑ 5-6** ูุดุงู ุฏุงุฏู ุดุฏูุ ด ฺฉูุฏ ฺฉุด (key0ุ key1ุ key2ุ key3) ุจุฑ ุฑู ุญููู ูุด (hash ring) ุชูุฒุน ุดุฏูโุงูุฏ. ุงู ุชูุฒุน ุจุฑ ุงุณุงุณ ุฎุฑูุฌ ุชุงุจุน ูุด ุงูุฌุงู ูโุดูุฏุ ฺฉู ุจู ุนููุงู ูููุนุช ฺฉูุฏ ุฑู ุญููู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.

---

## **ต.ด ุฌุณุชุฌู ุณุฑูุฑ (Server Lookup)**

ุจุฑุง ุชุนู ุงูฺฉู ฺฉ ฺฉูุฏ ุฏุฑ ฺฉุฏุงู ุณุฑูุฑ ุฐุฎุฑู ุดุฏูุ ุงุฒ ูููุนุช ุขู ฺฉูุฏ ุจุฑ ุฑู ุญููู ุจูโุตูุฑุช ุณุงุนุชฺฏุฑุฏ (Clockwise) ุญุฑฺฉุช ูโฺฉูู ุชุง ุจู ูุฒุฏฺฉโุชุฑู ุณุฑูุฑ ุจุฑุณู.

![](./Pictures/5-7.png)

ุฏุฑ **ุชุตูุฑ 5-7**ุ ุงู ูุฑุขูุฏ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช:

* key0 ุฑู ุณุฑูุฑ 0 ูุฑุงุฑ ูโฺฏุฑุฏ
* key1 ุฑู ุณุฑูุฑ 1
* key2 ุฑู ุณุฑูุฑ 2
* key3 ุฑู ุณุฑูุฑ 3

ุงู ุฑูุด ุชุถูู ูโฺฉูุฏ ฺฉู ฺฉูุฏูุง ุจุง ุชูุฒุน ฺฉููุงุฎุช ู ุจุฏูู ูุงุฒ ุจู ุจุงุฒูพฺฉุฑุจูุฏ ฺฏุณุชุฑุฏู ูุงู ุณุฑูุฑูุง ุชูุฒุน ุดููุฏ.

---

## **ต.ต ุงูุฒูุฏู ฺฉ ุณุฑูุฑ (Add a Server)**

ุจุฑ ุงุณุงุณ ููุทู ุชูุถุญ ุฏุงุฏูโุดุฏูุ ุงูุฒูุฏู ฺฉ ุณุฑูุฑ ุฌุฏุฏ ุชููุง ูุงุฒ ุจู **ุชูุฒุน ูุฌุฏุฏ ุจุฎุด ฺฉูฺฺฉ ุงุฒ ฺฉูุฏูุง** ุฏุงุฑุฏ.

![](./Pictures/5-8.png)

ุฏุฑ **ุชุตูุฑ 5-8**ุ ูพุณ ุงุฒ ุงุถุงูู ุดุฏู ุณุฑูุฑ ุฌุฏุฏ ุจุง ุดูุงุฑู ดุ ููุท **key0** ูุงุฒ ุจู ุจุงุฒุชุฎุตุต ุฏุงุฑุฏ. ุณุงุฑ ฺฉูุฏูุง (key1ุ key2ุ key3) ููฺูุงู ุฑู ููุงู ุณุฑูุฑูุง ูุจู ุจุงู ูโูุงููุฏ.

ุจุงุฏ ุฏููโุชุฑ ุจู ููุทู ุขู ูฺฏุงู ฺฉูู:

* **ูุจู ุงุฒ ุงุถุงูู ุดุฏู ุณุฑูุฑ ด**ุ ฺฉูุฏ key0 ุฑู ุณุฑูุฑ 0 ุฐุฎุฑู ูโุดุฏ.
* **ูพุณ ุงุฒ ุงุถุงูู ุดุฏู ุณุฑูุฑ ด**ุ key0 ุงฺฉููู ุฑู ุณุฑูุฑ ด ุฐุฎุฑู ูโุดูุฏ ฺูู ุณุฑูุฑ ด ุงููู ุณุฑูุฑ ุงุณุช ฺฉู ุงุฒ ูุญู key0 ุฏุฑ ูุณุฑ ุณุงุนุชฺฏุฑุฏ ุจู ุขู ูโุฑุณู.

ุจูู ฺฉูุฏูุง ูุงุฒ ุจู ุจุงุฒุชุฎุตุต ูุฏุงุฑูุฏุ ุฒุฑุง ูฺฉุงู ุขูโูุง ุฏุฑ ุญููู ุชุบุฑ ูฺฉุฑุฏู ู ุณุฑูุฑ ูุณุฆูู ุขูโูุง ููฺูุงู ููุงู ุงุณุช.

---

## **ต.ถ ุญุฐู ฺฉ ุณุฑูุฑ (Remove a Server)**

ุฏุฑ ุตูุฑุช ุญุฐู ฺฉ ุณุฑูุฑ ูุฒ ุชููุง ุจุฎุด ฺฉูฺฺฉ ุงุฒ ฺฉูุฏูุง ูุงุฒ ุจู ุจุงุฒุชุฎุตุต ุฏุงุฑูุฏ.

![](./Pictures/5-9.png)

ุฏุฑ **ุชุตูุฑ 5-9**ุ ุฒูุงูโฺฉู ุณุฑูุฑ ฑ ุญุฐู ูโุดูุฏุ ููุท **key1** ุจุงุฏ ุจู ุณุฑูุฑ ุจุนุฏุ ุนู **ุณุฑูุฑ ฒ** ููุชูู ุดูุฏ. ุณุงุฑ ฺฉูุฏูุง (key0ุ key2ุ key3) **ุชุบุฑ ููโฺฉููุฏ**.

ุงู ูุฒุช ููู ุงุฒ **Consistent Hashing** ุงุณุชุ ฺฉู ุฏุฑ ููุงุณู ุจุง ุฑูุดโูุง ุณูุช ูุดุ **ุชุฃุซุฑ ุชุบุฑุงุช ุฏุฑ ุชุนุฏุงุฏ ุณุฑูุฑูุง ุฑุง ุจู ุญุฏุงูู ูโุฑุณุงูุฏ** ู ุงุฒ ุจุงุฒุชุฎุตุต ฺฏุณุชุฑุฏู ุฏุงุฏูโูุง ุฌููฺฏุฑ ูโฺฉูุฏ.

---

\[+] **ูุทุงูุนู ููุฑุฏ: ุงุณุชูุงุฏู ุงุฒ Consistent Hashing ุฏุฑ Amazon Dynamo**

> ุณุณุชู ุฐุฎุฑูโุณุงุฒ Amazon Dynamo ฺฉู ุจุฑุง ูุญุตููุงุช ฺฉูุฏ ุขูุงุฒูู ุงุฒ ุฌููู ุณุจุฏ ุฎุฑุฏ (Shopping Cart) ุงุณุชูุงุฏู ูโุดูุฏุ ุงุฒ ุงูฺฏูุฑุชู Consistent Hashing ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ุจุงุฑ ุชูุฒุน ุฏุงุฏู ุจู ููุฏูุง ูุฎุชูู ุฑุง ูุฏุฑุช ฺฉูุฏ. ูุฑ ููุฏ ฺูุฏู "virtual node" ุฑู ุญููู ูุด ุฏุงุฑุฏ ุชุง ุชูุงุฒู ุจุงุฑ ุจูุชุฑ ุจุฑูุฑุงุฑ ุดูุฏ. ุงุถุงูู ุง ุญุฐู ููุฏ ุชููุง ุจุงุนุซ ุฌุงุจุฌุง ุฏุงุฏูโูุง ูุญุฏูุฏ ูโุดูุฏ ฺฉู ุฏุฑ ูุชุฌูุ ููุงุณโูพุฐุฑ ุงูู ุณุณุชู ุจูโุฎูุจ ุญูุธ ูโุดูุฏ.
> **ููุจุน**: Amazon Dynamo Paper (2007) โ ACM Symposium on Operating Systems Principles

---

\[+] **ุงุจุฒุงุฑูุง ูุชูโุจุงุฒ ูพุดููุงุฏ ุจุฑุง ูพุงุฏูโุณุงุฒ Consistent Hashing:**

* ๐น **Ketama**
  + [GitHub: https://github.com/RJ/ketama](https://github.com/RJ/ketama)
  + ฺฉุชุงุจุฎุงููโุง ูุจุชู ุจุฑ C ุจุฑุง ูพุงุฏูโุณุงุฒ Consistent Hashing ุจุง ูพุดุชุจุงู ุงุฒ virtual nodes. ุฏุฑ Memcached ูุฒ ุงุณุชูุงุฏู ูโุดูุฏ.
  + **ูุฒุงุง:** ุณุฑุนุ ุณุจฺฉุ ููุงุณุจ ุจุฑุง ุณุฑูุณโูุง cache
  + **ูุนุงุจ:** ุชูุณุนูโุงูุชู ุจุง Cุ ูุงุฒ ุจู binding ุฏุฑ ุฒุจุงูโูุง ุฏฺฏุฑ

* ๐น **Hashring (Python)**
  [PyPI: https://pypi.org/project/hashring](https://pypi.org/project/hashring)
  + ฺฉุชุงุจุฎุงููโุง ุณุงุฏู ู ูุคุซุฑ ุจุฑุง ูพุงุฏูโุณุงุฒ ุญููู ูุด ุฏุฑ ูพุงุชูู.
  + **ุณูุงุฑู ุงุณุชูุงุฏู:** ููุงุณุจ ุจุฑุง ุชูุฒุน ุจุงุฑ ุฑู ุณุฑูุฑูุง ฺฉุด ุง API
  + **ูุฒุงุง:** ูุตุจ ุขุณุงูุ ุจุฏูู ูุงุฒ ุจู Redis
  + **ูุนุงุจ:** ููุงุณุจ ููุท ุจุฑุง ุจุงุฑูุง ุณุจฺฉ

* ๐น **Consistent Hashing in Envoy Proxy (C++)**
  + [Envoy Docs: https://www.envoyproxy.io](https://www.envoyproxy.io)
  + Envoy ุงุฒ Consistent Hashing ุฏุฑ load balancing ุงุณุชูุงุฏู ูโฺฉูุฏ (ูุซูุงู ุจุฑ ุงุณุงุณ session ID).
  + **ูุฒุงุง:** ููุงุณุจ ุจุฑุง ุณุณุชูโูุง ูฺฉุฑูุณุฑูุณ ู real-time
  + **ูุนุงุจ:** ูพฺฉุฑุจูุฏ ูุณุจุชุงู ูพฺุฏู

---

## **ต.ท ุฏู ูุดฺฉู ุฏุฑ ุฑูุด ูพุงูโุง (Two Issues in the Basic Approach)**

ุงูฺฏูุฑุชู ูุดโุณุงุฒฺฏุงุฑ (Consistent Hashing) ูุฎุณุชูโุจุงุฑ ุชูุณุท **Karger ู ููฺฉุงุฑุงูุด ุฏุฑ MIT** ูุนุฑู ุดุฏ$1$. ูุฑุงุญู ุงุตู ุงู ุงูฺฏูุฑุชู ุจู ุดุฑุญ ุฒุฑ ุงุณุช:

* *ุณุฑูุฑูุง ู ฺฉูุฏูุง* ุชูุณุท ฺฉ ุชุงุจุน ูุด ุจุง ุชูุฒุน ฺฉููุงุฎุชุ ุฑู ุญููู ูุด (hash ring) ูฺฏุงุดุชู ูโุดููุฏ.
* ุจุฑุง ุชุนู ุงูฺฉู ฺฉ ฺฉูุฏ ุฏุฑ ฺฉุฏุงู ุณุฑูุฑ ุฐุฎุฑู ุดุฏู ุงุณุชุ ุงุฒ ูุญู ฺฉูุฏ ุจูโุตูุฑุช ุณุงุนุชฺฏุฑุฏ ุญุฑฺฉุช ูโฺฉูู ุชุง ุจู ุงููู ุณุฑูุฑ ููุฌูุฏ ุฑู ุญููู ุจุฑุณู.

ุจุง ูุฌูุฏ ุณุงุฏฺฏ ู ุงุซุฑุจุฎุด ุงู ุฑูฺฉุฑุฏุ ุฏู ูุดฺฉู ุงุณุงุณ ุฏุฑ ุงู ุงูฺฏูุฑุชู ูพุงูโุง ุดูุงุณุง ุดุฏู ุงุณุช:

---

### *ูุดฺฉู ุงูู: ุงูุฏุงุฒู ูุงูุชูุงุฒู ูพุงุฑุชุดูโูุง (Partitions)*

ุญูุธ ุงูุฏุงุฒู ฺฉุณุงู ุจุฑุง *ูพุงุฑุชุดูโูุง* (ุนู ุจุงุฒู ูุด ุจู ุฏู ุณุฑูุฑ ูุฌุงูุฑ ุฑู ุญููู) ุบุฑููฺฉู ุงุณุชุ ุจูโูฺู ุฏุฑ ุดุฑุงุท ฺฉู ุณุฑูุฑ ุฌุฏุฏ ุงุถุงูู ุง ุญุฐู ุดูุฏ.

![](./Pictures/5-10.png)

ุจุฑุง ูุซุงูุ ุฏุฑ **ุชุตูุฑ 5-10** ุงฺฏุฑ **ุณุฑูุฑ s1** ุญุฐู ุดูุฏุ ุงูุฏุงุฒู ูพุงุฑุชุดู ุณุฑูุฑ **s2** (ฺฉู ุจุง ููุดโูุง ุฏูุทุฑูู ูุดุงู ุฏุงุฏู ุดุฏู) **ุฏู ุจุฑุงุจุฑ** ุงูุฏุงุฒู ูพุงุฑุชุดูโูุง ุณุฑูุฑ s0 ู s3 ุฎูุงูุฏ ุจูุฏ.

ุงู ูุงุจุฑุงุจุฑ ููุฌุฑ ุจู ุชูุฒุน ุบุฑฺฉุณุงู ุจุงุฑ ุจู ุณุฑูุฑูุง ูโุดูุฏุ ฺฉู ูโุชูุงูุฏ ุจุงุนุซ ูุดุงุฑ ุจุด ุงุฒ ุญุฏ ุจุฑ ุจุฑุฎ ุณุฑูุฑูุง ู ุจูุงุงุณุชูุงุฏู ูุงูุฏู ุจุฑุฎ ุฏฺฏุฑ ุดูุฏ.

---

### *ูุดฺฉู ุฏูู: ุชูุฒุน ูุงูุชูุงุฒู ฺฉูุฏูุง (Key Distribution)*

ฺฉ ุฏฺฏุฑ ุงุฒ ูุดฺฉูุงุชุ **ุชูุฒุน ูุงูุชูุงุฒู ฺฉูุฏูุง** ุฑู ุญููู ูุด ุงุณุช. ุงฺฏุฑ ุณุฑูุฑูุง ุฏุฑ ูููุนุชโูุง ูุฑุงุฑ ุจฺฏุฑูุฏ ฺฉู ฺฉููุงุฎุช ูุจุงุดุฏุ ุชุนุฏุงุฏ ุฒุงุฏ ุงุฒ ฺฉูุฏูุง ููฺฉู ุงุณุช ุฑู ฺฉ ุณุฑูุฑ ุฎุงุต ูุชูุฑฺฉุฒ ุดููุฏุ ู ุจุฑุฎ ุณุฑูุฑูุง ูฺ ุฏุงุฏูโุง ูุฏุงุดุชู ุจุงุดูุฏ.

![](./Pictures/5-11.png)

ุฏุฑ **ุชุตูุฑ 5-11**ุ ูููุนุช ูุฑุงุฑฺฏุฑ ุณุฑูุฑูุง ุจูโฺฏูููโุง ุงุณุช ฺฉู **ุจุดุชุฑ ฺฉูุฏูุง ุฑู ุณุฑูุฑ ุดูุงุฑู ฒ ุฐุฎุฑู ุดุฏูโุงูุฏ**ุ ุฏุฑ ุญุงู ฺฉู **ุณุฑูุฑ ฑ ู ณ ูฺ ุฏุงุฏูโุง ุฏุฑ ุงุฎุชุงุฑ ูุฏุงุฑูุฏ**.

---

## \[+] ุฑุงูฺฉุงุฑ: ุงุณุชูุงุฏู ุงุฒ ฺฏุฑูโูุง ูุฌุงุฒ (Virtual Nodes)

ุจุฑุง ุญู ุงู ุฏู ูุดฺฉูุ ุฑูุด ุจู ูุงู **ฺฏุฑูโูุง ูุฌุงุฒ (Virtual Nodes)** ุง **ูุณุฎูโูุง ุชฺฉุฑุงุฑ (Replicas)** ูุนุฑู ุดุฏู ุงุณุช.

ุฏุฑ ุงู ุฑูุด:

* ูุฑ ุณุฑูุฑ ุจู ุฌุง ุงูฺฉู ููุท ฺฉ ูููุนุช ุฑู ุญููู ุฏุงุดุชู ุจุงุดุฏุ ุจู **ฺูุฏู ูููุนุช ูุฌุงุฒ (Virtual Node)** ุฑู ุญููู ูฺฏุงุดุชู ูโุดูุฏ.
* ุงู ูููุนุชโูุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุชุฑฺฉุจ ูุงู ุณุฑูุฑ ู ฺฉ ุดูุงุณู ฺฉุชุง ูุงููุฏ `server1#1`ุ `server1#2`ุ ... ูุด ูโุดููุฏ.

ูุฒุงุง ุงู ุฑูุด:

* ุชูุฒุน ฺฉููุงุฎุชโุชุฑ ุงุฒ ฺฉูุฏูุง ูุงู ุณุฑูุฑูุง ุญุงุตู ูโุดูุฏ.
* ุญุฐู ุง ุงุถุงูู ฺฉุฑุฏู ฺฉ ุณุฑูุฑ ุชุฃุซุฑ ฺฉูุชุฑ ุจุฑ ฺฉูุฏูุง ุณุณุชู ุฎูุงูุฏ ุฏุงุดุช.
* ุงูฺฉุงู **ุชุนุงุฏู ุจุงุฑ ุจูุชุฑ (load balancing)** ุจู ุณุฑูุฑูุง ูุฑุงูู ูโุดูุฏ.

---

\[+] **ูุทุงูุนู ููุฑุฏ: ุงุณุชูุงุฏู ุงุฒ Virtual Nodes ุฏุฑ Couchbase**

> ุณุณุชู ูพุงฺฏุงูโุฏุงุฏู ุชูุฒุนโุดุฏู **Couchbase** ุงุฒ ุงูฺฏูุฑุชู Consistent Hashing ุจู ููุฑุงู **ฺฏุฑูโูุง ูุฌุงุฒ** ุงุณุชูุงุฏู ูโฺฉูุฏ. ูุฑ ุณุฑูุฑ ุจู ฺูุฏู virtual node ูฺฏุงุดุชู ูโุดูุฏ ุชุง ููฺฏุงู ุงูุฒุงุด ุง ฺฉุงูุด ุธุฑูุชุ ุฏุงุฏูโูุง ุจุง ฺฉูุชุฑู ุฌุงุจุฌุง ููุชูู ุดููุฏ. ููฺูู ุงู ุฑูุด ููุฌุจ ุดุฏู ุชุง Couchbase ุจุชูุงูุฏ ุจูโุฎูุจ ููุงุณโูพุฐุฑ ุจุงู ุจูุงูุฏ.
> **ููุจุน:** [Couchbase Architecture Whitepaper](https://docs.couchbase.com)

---

\[+] **ุงุจุฒุงุฑูุง ูุชูโุจุงุฒ ุจุฑุง ูพุดุชุจุงู ุงุฒ Virtual Nodes:**

* **Ringpop**
  + [https://github.com/uber/ringpop-go](https://github.com/uber/ringpop-go)
  + ูุญุตูู ุงุฒ ุงูุจุฑ (Uber) ุจุฑุง ูพุงุฏูโุณุงุฒ ุชูุฒุน ุจุงุฑ ุจู ููุฏูุง ุจุง ูพุดุชุจุงู ฺฉุงูู ุงุฒ virtual nodes
  + **ูุฒุงุง:** ุชูุณุนูโุงูุชู ุจุฑุง ุณุฑูุณโูุง real-timeุ ูพุดุชุจุงู ุงุฒ ฺฏุฑูโูุง ูุฌุงุฒุ ููุงุณุจ ุจุฑุง ูุนูุงุฑโูุง ูฺฉุฑูุณุฑูุณ
  + **ูุนุงุจ:** ูุงุฒููุฏ ุฏุฑฺฉ ุฏูู ููุงูู ุชูุฒุนโุดุฏู ู ูพฺฉุฑุจูุฏ ูพฺุฏู

* **Consistent Hashing with Virtual Nodes in Java**
  + [https://github.com/doo/consistent-hash](https://github.com/doo/consistent-hash)
  + ูพุงุฏูโุณุงุฒ ุณุงุฏูโ ุงูฺฏูุฑุชู ุจุง ูพุดุชุจุงู ุงุฒ virtual nodes ุฏุฑ ุฒุจุงู Java
  + **ฺฉุงุฑุจุฑุฏ:** ุฏุฑ ุจุฑูุงููโูุง ุจุง ฺฉุด ุชูุฒุนโุดุฏู ุง ฺฉูุฏ-ููุฏุงุฑ (key-value stores)

---

## **ต.ธ ฺฏุฑูโูุง ูุฌุงุฒ (Virtual Nodes)**

*ฺฏุฑู ูุฌุงุฒ* (Virtual Node ุง VNode) ฺฉ ูฺฏุงุดุช ุงุฒ ุณุฑูุฑ ูุงูุน ุงุณุช ฺฉู ุจูโุตูุฑุช ูุณุชูู ุฑู ุญููู ูุด ูุฑุงุฑ ูโฺฏุฑุฏ. ูุฑ ุณุฑูุฑ ูุงูุน ุจูโุฌุง ุฏุงุดุชู ฺฉ ููุทูุ ุชูุณุท ฺูุฏู ฺฏุฑู ูุฌุงุฒ ููุงูุฏฺฏ ูโุดูุฏ. ุงู ุชฺฉูฺฉ ฺฉ ุงุฒ ุฑุงูฺฉุงุฑูุง ูุคุซุฑ ุจุฑุง ูุชุนุงุฏูโุณุงุฒ ุชูุฒุน ฺฉูุฏูุง ู ุจุงุฑ ุณุฑูุฑูุง ุฏุฑ ุงูฺฏูุฑุชู ูุดโุณุงุฒฺฏุงุฑ ุงุณุช.

![](./Pictures/5-12.png)

ุฏุฑ **ุชุตูุฑ ต-ฑฒ**ุ ูุฑ ฺฉ ุงุฒ ุณุฑูุฑูุง (server 0 ู server 1) ุจุง ณ ฺฏุฑู ูุฌุงุฒ ุฑู ุญููู ููุงุด ุฏุงุฏู ุดุฏูโุงูุฏ. ุงู ุชุนุฏุงุฏ ุจูโุตูุฑุช ุฏูุฎูุงู ุงูุชุฎุงุจ ุดุฏู ู ุฏุฑ ุณุณุชูโูุง ูุงูุนุ ุชุนุฏุงุฏ ฺฏุฑูโูุง ูุฌุงุฒ ุจุฑุง ูุฑ ุณุฑูุฑ ููฺฉู ุงุณุช ุจู **ุตุฏูุง ุง ูุฒุงุฑุงู ุนุฏุฏ** ุจุฑุณุฏ.

ุจูโุนููุงู ูุซุงู:

* ุณุฑูุฑ ฐ ุจุง ฺฏุฑูโูุง `s0_0`ุ `s0_1` ู `s0_2` ููุงุด ุฏุงุฏู ุดุฏู.
* ุณุฑูุฑ ฑ ุจุง ฺฏุฑูโูุง `s1_0`ุ `s1_1` ู `s1_2` ููุงุด ุฏุงุฏู ุดุฏู.

ูุฑ ฺฏุฑู ูุฌุงุฒ ูุณุฆูู ูุฏุฑุช ฺฉ ุจุฎุด ุงุฒ ุญููู ูุด (ูพุงุฑุชุดู) ุงุณุชุ ุงูุง ููฺฏุงู ุฏุณุชุฑุณ ุจู ุฏุงุฏูุ ูุฑุฌุน ุขู ฺฏุฑู ุจู ุณุฑูุฑ ูุฒฺฉ ูุงูุน ุจุงุฒูโฺฏุฑุฏุฏ.

---

### *ูุญูู ูพุฏุง ฺฉุฑุฏู ุณุฑูุฑ ููุตุฏ ฺฉ ฺฉูุฏ*

![](./Pictures/5-13.png)

ุจุฑุง ุงูุชู ุณุฑูุฑ ฺฉู ฺฉ ฺฉูุฏ ุฎุงุต (ูุซูุงู `k0`) ุฏุฑ ุขู ุฐุฎุฑู ุดุฏูุ ุงุฒ ูููุนุช ฺฉูุฏ ุฑู ุญููู ุจูโุตูุฑุช ุณุงุนุชฺฏุฑุฏ ุญุฑฺฉุช ูโฺฉูู ุชุง ุจู **ูุฎุณุชู ฺฏุฑู ูุฌุงุฒ** ุจุฑุณู. ุณูพุณ ฺฏุฑู ูุฌุงุฒ ุฑุง ุจู ุณุฑูุฑ ูุงูุนโุงุด ูฺฏุงุดุช ูโุฏูู.

ุฏุฑ **ุชุตูุฑ ต-ฑณ**ุ ุงฺฏุฑ ุงุฒ ูููุนุช `k0` ุจูโุตูุฑุช ุณุงุนุชฺฏุฑุฏ ุญุฑฺฉุช ฺฉููุ ูุฎุณุชู ฺฏุฑู ูุฌุงุฒ ุจุฑุฎูุฑุฏ `s1_1` ุงุณุชุ ุจูุงุจุฑุงู ุฏุงุฏู ูุฑุจูุท ุจู `k0` ุฏุฑ **ุณุฑูุฑ ฑ** ูุฑุงุฑ ุฏุงุฑุฏ.

---

### *ูุฒุงุง ุงุณุชูุงุฏู ุงุฒ ฺฏุฑูโูุง ูุฌุงุฒ*

ุงูุฒุงุด ุชุนุฏุงุฏ ฺฏุฑูโูุง ูุฌุงุฒ ุจุงุนุซ ูโุดูุฏ **ุชูุฒุน ฺฉูุฏูุง ุจู ุณุฑูุฑูุง ูุชุนุงุฏูโุชุฑ ุดูุฏ**. ุงู ููุถูุน ุจู ฺฉุงูุด ุงูุญุฑุงู ูุนุงุฑ ุฏุฑ ุชูุฒุน ฺฉูุฏูุง ูโุงูุฌุงูุฏุ ฺฉู ฺฉ ุงุฒ ูุนุงุฑูุง ฺฉูุฏ ุฏุฑ ุงุฑุฒุงุจ ฺฉููุงุฎุช ุฏุงุฏู ุงุณุช.

> **ุงูุชูโูุง ุชุฌุฑุจ** (ุจุฑุงุณุงุณ ฺฉ ุชุญูู ุขููุงู $2$):
>
> * ุงฺฏุฑ ุงุฒ **ฑฐฐ ฺฏุฑู ูุฌุงุฒ** ุงุณุชูุงุฏู ุดูุฏุ ุงูุญุฑุงู ูุนุงุฑ ุชูุฑุจุงู **ฑฐูช** ุงุฒ ููุฏุงุฑ ูุงูฺฏู ุงุณุช.
> * ุงฺฏุฑ ุงุฒ **ฒฐฐ ฺฏุฑู ูุฌุงุฒ** ุงุณุชูุงุฏู ุดูุฏุ ุงู ููุฏุงุฑ ุจู **ตูช** ฺฉุงูุด ูโุงุจุฏ.
> * ุจุง ุงูุฒุงุด ุจุดุชุฑ ุชุนุฏุงุฏ ฺฏุฑูโูุง ูุฌุงุฒุ ุงูุญุฑุงู ูุนุงุฑ ฺฉูุชุฑ ุฎูุงูุฏ ุดุฏุ ุงูุง ูุฒููโ ุญุงูุธู ุจุฑุง ูฺฏูุฏุงุฑ ฺฏุฑูโูุง ูุฒ ุงูุฒุงุด ูโุงุจุฏ.

ุงู ููุถูุน ฺฉ **ููุงุฒูู (trade-off)** ููู ุงุณุช ู ุจุงุฏ ุจุง ุชูุฌู ุจู ูุงุฒ ุณุณุชูุ ุชุนุฏุงุฏ ฺฏุฑูโูุง ูุฌุงุฒ ุจูโุฏุฑุณุช ุชูุธู ุดูุฏ.

---

## **ต.น ุดูุงุณุง ฺฉูุฏูุง ุชุญุช ุชุฃุซุฑ (Find Affected Keys)**

ููฺฏุงู **ุงูุฒูุฏู ุง ุญุฐู ฺฉ ุณุฑูุฑ**ุ ุชููุง ุจุฎุด ุงุฒ ฺฉูุฏูุง ุจุงุฏ ุจุงุฒุชุฎุตุต (redistribute) ุงุจูุฏ. ุงูุง ุณุคุงู ุงูุฌุงุณุช: **ฺฉุฏุงู ูุญุฏูุฏู ุงุฒ ฺฉูุฏูุง ุชุญุช ุชุฃุซุฑ ูุฑุงุฑ ูโฺฏุฑุฏุ**

---

### *ุงูุฒูุฏู ฺฉ ุณุฑูุฑ ุฌุฏุฏ*

![](./Pictures/5-14.png)

ุฏุฑ **ุชุตูุฑ ต-ฑด**ุ ุณุฑูุฑ ด ุจู ุญููู ุงุถุงูู ุดุฏู ุงุณุช. ุจุฑุง ุชุนู ฺฉูุฏูุง ุชุญุช ุชุฃุซุฑ:

* ุงุฒ ูููุนุช ุณุฑูุฑ ุฌุฏุฏ (`s4`) ุจูโุตูุฑุช **ูพุงุฏุณุงุนุชฺฏุฑุฏ** ุญุฑฺฉุช ูโฺฉูู ุชุง ุจู ฺฉ ุณุฑูุฑ ููุฌูุฏ ุฏฺฏุฑ (`s3`) ุจุฑุณู.
* ุชูุงู ฺฉูุฏูุง ฺฉู ุฏุฑ ุงู ุจุงุฒู ูุฑุงุฑ ุฏุงุฑูุฏ (ุจู `s3` ุชุง `s4`) ุจุงุฏ ุจู ุณุฑูุฑ ุฌุฏุฏ (`s4`) ููุชูู ุดููุฏ.

---

### *ุญุฐู ฺฉ ุณุฑูุฑ*

![](./Pictures/5-15.png)

ุฏุฑ **ุชุตูุฑ ต-ฑต**ุ ุณุฑูุฑ ฑ ุงุฒ ุญููู ุญุฐู ุดุฏู ุงุณุช. ุฏุฑ ุงู ุญุงูุช:

* ุงุฒ ูููุนุช ุณุฑูุฑ ุญุฐูโุดุฏู (`s1`) ุจูโุตูุฑุช **ูพุงุฏุณุงุนุชฺฏุฑุฏ** ุญุฑฺฉุช ูโฺฉูู ุชุง ุจู ูุฒุฏฺฉโุชุฑู ุณุฑูุฑ ููุฌูุฏ (ุฏุฑ ุงูุฌุง `s0`) ุจุฑุณู.
* ุชูุงู ฺฉูุฏูุง ฺฉู ุฏุฑ ุงู ูุงุตูู ูุฑุงุฑ ุฏุงุฑูุฏ ุจุงุฏ ุจู ุณุฑูุฑ ุฌุงฺฏุฒู (ุฏุฑ ุงูุฌุง `s2`) ููุชูู ุดููุฏ.

---

\[+] **ูุทุงูุนู ููุฑุฏ: ุงุณุชูุงุฏู ุงุฒ Virtual Nodes ุฏุฑ Amazon Dynamo**

> ูพุงฺฏุงู ุฏุงุฏู ุชูุฒุนโุดุฏู **Amazon DynamoDB** ุงุฒ ฺฏุฑูโูุง ูุฌุงุฒ ุจูโุทูุฑ ฺฏุณุชุฑุฏู ุงุณุชูุงุฏู ูโฺฉูุฏ. ุฏุฑ ุทุฑุงุญ ุงููู Dynamoุ ูุฑ ููุฏ ููุทู ฺูุฏู ฺฏุฑู ูุฌุงุฒ ุฑู ุญููู ูุด ุฏุงุฑุฏ ฺฉู ุจุงุนุซ ุดุฏู ุงูุฒููฺฏุ ุชุนุงุฏู ุจุงุฑ ู ุชุญูู ุฎุทุง ุจูโุทูุฑ ูุคุซุฑ ูพุงุฏูโุณุงุฒ ุดูุฏ. ุงู ุณุงุฎุชุงุฑ ููฺูู ุจู Dynamo ุงูฺฉุงู ูโุฏูุฏ ุฏุฑ ุจุฑุงุจุฑ ุงูุฒูุฏู ุดุฏู ุง ุญุฐู ูุงฺฏูุงู ููุฏูุง ููุงูู ุจุงู ุจูุงูุฏ.
> **ููุจุน:** [Amazon Dynamo Paper - SOSP 2007](https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf)

---

\[+] **ุงุจุฒุงุฑูุง ูุชูโุจุงุฒ ุจุฑุง ูพุงุฏูโุณุงุฒ ฺฏุฑูโูุง ูุฌุงุฒ ู ูุฏุฑุช ฺฉูุฏูุง ุชุฃุซุฑูพุฐุฑ**

* **Ketama**

  * ููฺฉ: [https://github.com/RJ/ketama](https://github.com/RJ/ketama)
  * ุชูุถุญ: ฺฉุชุงุจุฎุงููโ C ุจุฑุง ูพุงุฏูโุณุงุฒ consistent hashing ุจุง ูพุดุชุจุงู ุงุฒ virtual nodes.
  * ูุฒุงุง: ฺฉุงุฑุง ุจุงูุงุ ุงุณุชูุงุฏูโุดุฏู ุฏุฑ Memcached ู ุชูุฒุน ุจุงุฑ ูุณโุจูฺฉ.
  * ูุนุงุจ: ูุงุฒ ุจู ุงุฏุบุงู ุจุง ุณุฑูุณโูุง ุฏฺฏุฑ ุจูโุตูุฑุช ุฏุณุช.

* **Hashring (Python)**

  * ููฺฉ: [https://pypi.org/project/hashring/](https://pypi.org/project/hashring/)
  * ุชูุถุญ: ูุงฺูู ูพุงุชูู ุจุฑุง ูพุงุฏูโุณุงุฒ ุงูฺฏูุฑุชู ูุดโุณุงุฒฺฏุงุฑ ุจุง ูุงุจูุช ฺฏุฑูโูุง ูุฌุงุฒ.
  * ูุฒุงุง: ุณุงุฏฺฏุ ููุงุณุจ ุจุฑุง ูพุฑูฺูโูุง ูุชูุณุท
  * ูุนุงุจ: ููุงุณุจ ุจุฑุง ูพุฑูฺูโูุง ุจุง ุจุงุฑ ุณูฺฏู ูุณุช.

## 5.10 ููุงูู ฺฉุงุฑุจุฑุฏ:


---

#### ูุดูฺฏ ูพุงุฏุงุฑ ุจุง ุฌุณุชุฌู ุฏูุฏู (Consistent Hashing with Binary Search)

โ ููุณูุฏู: Arpit Bhayani
๐ฏ ูุฏู: ุญู ูุดฺฉู ุชูุฒุน ฺฉููุงุฎุช ุฏุงุฏูโูุง ููฺฏุงู ุชุบุฑ ุชุนุฏุงุฏ ุณุฑูุฑูุง (ฺฏุฑูโูุง) ุจุง ุงุณุชูุงุฏู ุงุฒ ูุดูฺฏ ูพุงุฏุงุฑ ู ุฌุณุชุฌู ุฏูุฏู.

+ [ููฺฉ ููุงูู](https://www.codementor.io/@arpitbhayani/consistent-hashing-with-binary-search-16rec8e8eh)
---

## ๐ง ูุดฺฉู ุงุตู ูุด ุณูุช

ุฏุฑ ูุนูุงุฑ ุชูุฒุนโุดุฏูุ ูุนููู ุงุณุช ฺฉู ุงุฒ ูุด ุชุงุจุน ุจุฑุง ุชุฎุตุต ูุงูโูุง ุง ฺฉุงุฑุจุฑุงู ุจู ุณุฑูุฑูุง ุงุณุชูุงุฏู ุดูุฏ:

```python
idx = hash(key) % N  # N ุชุนุฏุงุฏ ฺฏุฑูโูุงุณุช
```

โ ุงูุง ููุช ุชุนุฏุงุฏ ฺฏุฑูโูุง (N) ุชุบุฑ ฺฉูุฏุ ุชูุงู ุขุชูโูุง ููฺฉู ุงุณุช ุจู ฺฏุฑู ุฏฺฏุฑ ุชุฎุตุต ูพุฏุง ฺฉููุฏ โ ุจุงุฒุชูุฒุน ฺฉุงูู ุฏุงุฏู = ูุฒูู ุฒุงุฏ.

---

## โ ุฑุงูโุญู: Consistent Hashing

ุฏุฑ ูุดูฺฏ ูพุงุฏุงุฑุ ฺฉู ูุถุง ูุด ุจู ุตูุฑุช ฺฉ ุฏุงุฑู (ูุดโุฑูฺฏ) ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.

### ุฑููุฏ ุชุฎุตุต:

* ูุฑ ุณุฑูุฑ ุฏุฑ ูููุนุช ุฑู ุฏุงุฑู ูุด ูุฑุงุฑ ูโฺฏุฑุฏ (ุจุฑ ุงุณุงุณ hash ุขุฏุฑุณ IP).
* ูุฑ ฺฉูุฏ (ูุซูุงู ูุงู ูุงู ุง ฺฉุงุฑุจุฑ) ูู ูุด ูโุดูุฏ ู ุฑู ุฏุงุฑู ูุฑุงุฑ ูโฺฏุฑุฏ.
* ุขุชู ุจู ุงููู ุณุฑูุฑ ฺฉู ุฏุฑ ุฌูุช ุณุงุนุชฺฏุฑุฏ ุจุนุฏ ุงุฒ ูููุนุช ฺฉูุฏ ูุฑุงุฑ ุฏุงุฑุฏ ุชุฎุตุต ุฏุงุฏู ูโุดูุฏ.

---

## โ๏ธ ูพุงุฏูโุณุงุฒ ฺฉุงูู ุฏุฑ ูพุงุชูู

### 1. ุชุงุจุน ูุด ุจุง SHA-256

```python
import hashlib

def hash_fn(key: str, total_slots: int) -> int:
    h = hashlib.sha256()
    h.update(key.encode('utf-8'))
    return int(h.hexdigest(), 16) % total_slots
```

* ุงุฒ `hashlib.sha256` ุจุฑุง ฺฉููุงุฎุช ุชูุฒุน ุงุณุชูุงุฏู ูโุดูุฏ.
* `total_slots` ูุถุง ุจุฒุฑฺฏ ูุด ุงุณุชุ ูุนูููุงู $2^{16}$ ุง ุจุดุชุฑ.

---

### 2. ฺฉูุงุณ `ConsistentHashing`

```python
from bisect import bisect, bisect_right, bisect_left

class ConsistentHashing:
    def __init__(self, total_slots: int):
        self.total_slots = total_slots
        self._keys = []      # ูููุนุชโูุง ูุด ุณุฑูุฑูุง ุฑู ุฏุงุฑู
        self.nodes = []      # ุงุดุงุก Node ูุชูุงุธุฑ ุจุง ูุฑ ฺฉูุฏ

    def add_node(self, node):
        key = hash_fn(node.host, self.total_slots)
        idx = bisect(self._keys, key)
        if idx > 0 and self._keys[idx-1] == key:
            raise Exception("Collision")  # ุจุฑุฎูุฑุฏ ูุด
        self._keys.insert(idx, key)
        self.nodes.insert(idx, node)
        return key

    def remove_node(self, node):
        if not self._keys:
            raise Exception("Empty")
        key = hash_fn(node.host, self.total_slots)
        idx = bisect_left(self._keys, key)
        if idx >= len(self._keys) or self._keys[idx] != key:
            raise Exception("Not exist")
        self._keys.pop(idx)
        self.nodes.pop(idx)
        return key

    def get_node(self, item):
        if not self._keys:
            return None
        key = hash_fn(item, self.total_slots)
        idx = bisect_right(self._keys, key) % len(self._keys)
        return self.nodes[idx]
```

---

### 3. ุชุณุช ุนููฺฉุฑุฏ:

```python
if __name__ == "__main__":
    ch = ConsistentHashing(total_slots=2**16)

    class Node:
        def __init__(self, host): self.host = host
        def __repr__(self): return f"Node({self.host})"

    for host in ["10.0.0.1", "10.0.0.2", "10.0.0.3"]:
        ch.add_node(Node(host))

    items = ["f1.txt", "f2.txt", "f3.txt"]
    for it in items:
        print(it, "->", ch.get_node(it))
```

### ุฎุฑูุฌ ุงุญุชูุงู:

```
f1.txt -> Node(10.0.0.2)
f2.txt -> Node(10.0.0.3)
f3.txt -> Node(10.0.0.1)
```

---

## ๐ก ุจูุจูุฏ: Virtual Nodes (ฺฏุฑูโูุง ูุฌุงุฒ)

ูุฑ ุณุฑูุฑ ูโุชูุงูุฏ ฺูุฏ ูููุนุช ูุฎุชูู ุฑู ุฏุงุฑู ุฏุงุดุชู ุจุงุดุฏ ุชุง ุจุงุฑ ุชูุฒุนโุดุฏูโุชุฑ ุดูุฏ.

ูุซูุงู:

```python
for i in range(3):
    ch.add_node(Node(f"10.0.0.1-{i}"))
```

---

## ๐ ุฌูุนโุจูุฏ ููุง

| ูฺฺฏ                | ูุด ุณูุช    | ูุด ูพุงุฏุงุฑ |
| -------------------- | ---------- | --------- |
| ุชูุฒุน ฺฉููุงุฎุช        | โ          | โ         |
| ุญุณุงุณ ุจู ุชุบุฑ ฺฏุฑูโูุง | โ          | โ         |
| ููุงุณโูพุฐุฑ           | โ          | โ         |
| ุจุงุฑ ูุฌุฏุฏ ุฏุงุฏูโูุง     | ุจุณุงุฑ ุฒุงุฏ | ฺฉู (k/n)  |

---

## ๐จโ๐ซ ููุงุณุจ ุจุฑุง ฺู ูพุฑูฺูโูุงุ

* ุชูุฒุน ูุงูโูุง (CDNุ IPFS)
* ุชูุฒุน ุจุงุฑ ฺฉุงุฑุจุฑุงู ุฏุฑ ฺฏูโุณุฑูุฑูุง
* ูุณุฑุงุจ ุชุฑุงูฺฉ (Load Balancer)
* Cache Systems ูุงููุฏ Memcachedุ Redis Cluster
* ูพุงฺฏุงูโุฏุงุฏูโูุง ุชูุฒุนโุดุฏู ูุงููุฏ Cassandra ู DynamoDB

